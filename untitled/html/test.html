<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <link href="css\mega.css" rel="stylesheet" type="text/css">
    <link href="css\test.css" rel="stylesheet" type="text/css">
    <link href="css\buttonsLeft.css" rel="stylesheet" type="text/css">
    <link href="css\buttonsTop.css" rel="stylesheet" type="text/css">
    <link href="css\buttonsCentr.css" rel="stylesheet" type="text/css">
    <link href="css\buttonsRight.css" rel="stylesheet" type="text/css">
    <link href="js\test.js" rel="stylesheet" type="text/xml">
    <script src="js\drag.js"></script>
    <style>

    </style>
</head>
<body>
<input id="in1">
<input id="in2">
    <buttonsLeft    >
        <button onclick="showHideBtn2('#zakaz')" class="box" id="zakaz"><img src="css\dialog1.jpg" alt=""><div class="text">Заказы</div></button>
        <button onclick="showHideBtn2('#viezd')" class="box" id="viezd"><img src="css\lamba1.png" alt=""><div class="text">Выезды</div></button>
        <button onclick="showHideBtn2('#otchet')" class="box" id="otchet"><img src="css\Otchet1.jpg" alt=""><div class="text">Отчёты</div></button>
        <button onclick="showHideBtn2('#masters')" class="box" id="masters"><img src="css\medium.jpg" alt=""><div class="text">Мастера</div></button>
    </buttonsLeft>
    <buttonsTop    >
        <button onclick="showHideBtn1()" class="box invisible" id="back"><div class="text1">Back</div></button>
        <button onclick="showHideBtn1()" class="box" id="profile"><div class="text1">MistFors@mail.ru</div><div class="text2">MistFors</div><img src="css\Profile.PNG" alt=""></button>
    </buttonsTop>
    <buttonsCentr>
        <button onclick="showHideBtn1()" class="box" id="remaile"><div class="text1">Изменить почту</div></button>
        <button onclick="showHideBtn1()" class="box" id="rename"><div class="text1">Изменить ФИО</div></button>
        <button onclick="showHideBtn1()" class="box" id="relogo"><div class="text1">Изменить иконку</div></button>
        <button onclick="new1()" class="box" id="new1"><div class="text1">new</div></button>
        <button onclick="new2()" class="box" id="new2"><div class="text1">new</div></button>
        <button onclick="new3()" class="box" id="new3"><div class="text1">new</div></button>
        <button onclick="new4()" class="box" id="new4"><div class="text1">new</div></button>
    </buttonsCentr>

<tablic class="tablic invisible" id="tablica">

    <fon id="fons">
        <div class="colum" style="background-color: #777778"><div class="slot droppable"></div></div>
        <div class="colum" style="background-color: #a6a6a7"><div class="slot droppable"></div></div>
        <div class="colum" style="background-color: #c6c6c7"><div class="slot droppable"></div></div>
    </fon>
    <buttonsRight    >
        <form class="box invisible" id="redzakaz"><div class="text">Заказы</div></form>
        <form class="box invisible" id="redviezd"><div class="text">Выезды</div></form>
        <form class="box invisible" id="redotchet"><div class="text">Отчёты</div></form>
        <form class="box invisible" id="redmasters"><div class="text">Мастера</div></form>
    </buttonsRight>



</tablic>
<script type="text/javascript">
    btn = document.createElement('BUTTON');
    btn.id='cm3';
    btn.onclick=function (){

        const tom = {
            name: "Tom",
            age: 37
        };
// кодируем объект в формат json
        const data = JSON.stringify(tom);
        const xhr = new XMLHttpRequest();

        xhr.open("POST", "/add");
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onload = () => {
            if (xhr.status == 200) {
                const user = JSON.parse(xhr.responseText)
                console.log(user);
                //btn.textContent=user.name;
            } else {
                console.log("Server response: ", xhr.statusText);
            }
        };
        xhr.send(data);
    }
    btn.textContent='1111';
    document.body.appendChild(btn);

</script>

<!--<p><div class="loader"></div></p>-->

<script>
    let Itemid;
    let Table;
    function onload(){
    send("/add",
        {
            id: document.querySelector('#in1').value,
            tag: document.querySelector('#in1').value
        });
}
function op(el){
    el.parentId
}




    DragManager.onDragCancel = function(dragObject) {
        dragObject.avatar.rollback();
    };

    DragManager.onDragEnd = function(dragObject, dropElem) {
        dragObject.elem.style= "";
        dropElem.appendChild(dragObject.elem);
    };









function profile(button)
{
button.className="zzz";
}
function showHideBtn1() {
    document.querySelector('#zakaz').classList.toggle('invisible');
    document.querySelector('#viezd').classList.toggle('invisible');
    document.querySelector('#otchet').classList.toggle('invisible');
    document.querySelector('#masters').classList.toggle('invisible');
    document.querySelector('#profile').classList.toggle('full');
    document.querySelector('#remaile').classList.toggle('full');
    document.querySelector('#rename').classList.toggle('full');
    document.querySelector('#relogo').classList.toggle('full');
    document.querySelector('#back').classList.toggle('invisible');
};
function showHideBtn2(fff) {
    document.querySelector('#profile').classList.toggle('invisible');
    document.querySelector('#zakaz').classList.toggle('invisible');
    document.querySelector('#viezd').classList.toggle('invisible');
    document.querySelector('#otchet').classList.toggle('invisible');
    document.querySelector('#masters').classList.toggle('invisible');
    document.querySelector(fff).classList.toggle('invisible');
    document.querySelector(fff).classList.toggle('full');

    if (fff=='#viezd')
    {
        new2();
        Table=document.querySelector('#tablica');
        Table.classList.toggle('invisible');
        document.querySelector('#new1').classList.toggle('full');
        document.querySelector('#new2').classList.toggle('full');
    }
};
async function new1() {
// клонируем элемент articleDiv
    newslot(document.querySelector('#in1').value,document.querySelector('#in2').value)
    let test={
        id: document.querySelector('#in2').value,
        tag: document.querySelector('#in1').value
    }
    //var now = new Date();
    send1("/add",
        {
            //time: now.getFullYear()+"."+now.getMonth(),
            id: document.querySelector('#in2').value,
            tag: document.querySelector('#in1').value
        });


};
async function new2() {
// клонируем элемент articleDiv
        send3("/take",
            {
                id: document.querySelector('#in2').value,
                tag: document.querySelector('#in1').value
            },
            function (user){
                let slot =document.querySelector('#fons .slot')
                while (slot.firstChild) {
                    slot.removeChild(slot.firstChild);
                }
                for(let elm of user)
                {
                    newslot(elm.tag,elm.id)
                }
            }
            );


    };
async function new3() {
// клонируем элемент articleDiv
        newslot(document.querySelector('#in1').value,document.querySelector('#in2').value)
        let test={
            id: document.querySelector('#in2').value,
            tag: document.querySelector('#in1').value
        }
        send1("/add",
            {
                id: document.querySelector('#in2').value,
                tag: document.querySelector('#in1').value
            });


    };
async function new4() {
// клонируем элемент articleDiv
        newslot(document.querySelector('#in1').value,document.querySelector('#in2').value)
        let test={
            id: document.querySelector('#in2').value,
            tag: document.querySelector('#in1').value
        }
        send1("/add",
            {
                id: document.querySelector('#in2').value,
                tag: document.querySelector('#in1').value
            });


    };
    function send3(url,json,func){
// кодируем объект в формат json
        const data = JSON.stringify(json);
        const xhr = new XMLHttpRequest();

        xhr.open("POST", url);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(data);
        xhr.onload = () => {
            if (xhr.status == 200) {
                let user =  JSON.parse(xhr.responseText)
                console.log(user);
                func(user);
                //document.querySelector('#redzakaz input').value=user[0].tag

            } else {
                console.log("Server response: ", xhr.statusText);
            }
        };



    }
    function send1(url,json){
// кодируем объект в формат json
        const data = JSON.stringify(json);
        const xhr = new XMLHttpRequest();

        xhr.open("POST", url);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(data);
        xhr.onload = () => {
            if (xhr.status == 200) {
                let user =  JSON.parse(xhr.responseText)
                console.log(user);

            } else {
                console.log("Server response: ", xhr.statusText);
            }
        };



    }
    function remove(item){
        send1("/delet",
            {
                id: item.id
            });
        document.querySelector('#fons .slot').removeChild(item);
    }
    function saveInfo(id1,item){
        send1("/update",
            {
                id1:id1,
                id: item.id,
                tag:item.tag
            },);
    }
    function moreInfo(item){
        send3("/take",
            {
                id: item.id
            },
            function (user){let slot =document.querySelector('#redzakaz')
                while (slot.firstChild) {
                slot.removeChild(slot.firstChild);
                }
                Itemid=item.id;
                let text = document.createElement("div")
                text.textContent='Заказ '+user[0].id;
                text.className='text';
                let but = document.createElement("div")
                let button = document.createElement("button")
                button.onclick=function (){
                    saveInfo(Itemid,{
                        id:document.querySelector('#id').value,
                        tag:document.querySelector('#tag').value
                    })
                    new2();
                    return false;
                }

                button.textContent="Сохранить"
                but.appendChild(button);
                text.textContent='Заказ '+user[0].id;
                text.className='text';
                slot.appendChild(text)

                for (var elm of user) {
                    for (var key in elm) {
                        if (key!="_id")
                        newinput(elm[key],[key])
                    }
                }
                slot.appendChild(but)
            }
            );
        document.querySelector('#redzakaz').classList.toggle('invisible');
    }
function newslot(name,id){
    let newArticleDiv = document.createElement("div")
    let button1 = document.createElement("button")
    button1.textContent='delet';
    button1.className='delet';
    button1.onclick= function(){remove(this.parentNode)};
    let button2 = document.createElement("button")
    button2.textContent='change';
    button2.className='change';
    button2.onclick= function(){moreInfo(this.parentNode)};
    newArticleDiv.textContent=name;
    newArticleDiv.id=id;
    newArticleDiv.draggable="true";
    newArticleDiv.className='draggable';
    let tab= document.querySelector('.tablic:not(.invisible)');
    let fons=document.querySelector('#fons');
    let max=0;
    for(let elm of fons.children){
        for(let elm1 of elm.children) {
            if (elm1.children.length>max)
                max=elm1.children.length;
        }
    }
    max+=4;
    //console.log(tab.children.length*100);
    Table.style.height=max*100+"px";
    newArticleDiv.appendChild(button1);
    newArticleDiv.appendChild(button2);
    document.querySelector('#fons .slot').appendChild(newArticleDiv);
}
    function newinput(tags,id){
        let newArticleDiv1 = document.createElement("div")
        newArticleDiv1.textContent=id+" :";
        newArticleDiv1.style='font-size: 32px;'
        let newArticleDiv = document.createElement("input")
        newArticleDiv.value=tags;
        newArticleDiv.id=id;
        newArticleDiv1.appendChild(newArticleDiv);
        //console.log(tab.children.length*100);
        document.querySelector('#redzakaz').appendChild(newArticleDiv1);

    }

</script>

</body>
</html>